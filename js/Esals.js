var tipoVehiculos = new Array({ tipo: '2D', descripcion: 'Camión de 2 ejes pequeños', img: '2D.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: null, eje4: null, peso1: 6.6138, peso2: 8.8184, peso3: null, peso4: null }, { tipo: '2DA', descripcion: 'Camión de 2 ejes medianos', img: '2DA.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: null, eje4: null, peso1: 6.6138, peso2: 15.4322, peso3: null, peso4: null }, { tipo: '2DB', descripcion: 'Camión de 2 ejes grandes', img: '2DB.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: null, eje4: null, peso1: 15.4322, peso2: 24.2506, peso3: null, peso4: null }, { tipo: '3-A', descripcion: 'Camión de 3 ejes', img: '3-A.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: null, eje4: null, peso1: 15.4322, peso2: 44.092, peso3: null, peso4: null }, { tipo: '4-C', descripcion: 'Camión de 4 ejes', img: '4-C.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 3, eje3: null, eje4: null, peso1: 15.4322, peso2: 52.9104, peso3: null, peso4: null }, { tipo: '4-D', descripcion: 'Camión con tamdem y direccional y tamdem posterior', img: '4-D.PNG', porcentaje: null, checked: false, eje1: 2, eje2: 2, eje3: null, eje4: null, peso1: 26.4552, peso2: 44.092, peso3: null, peso4: null }, { tipo: 'V2DB', descripcion: 'Volqueta de dos ejes 8 m3', img: 'V2DB.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: null, eje4: null, peso1: 15.4322, peso2: 24.2506, peso3: null, peso4: null }, { tipo: 'V3A', descripcion: 'Volqueta de tres ejes 10-14 m3', img: 'V3A.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: null, eje4: null, peso1: 15.4322, peso2: 44.092, peso3: null, peso4: null }, { tipo: 'VZS', descripcion: 'Volqueta ZS de tres ejes 16 m3', img: 'VZS.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: null, eje4: null, peso1: 15.4322, peso2: 44.092, peso3: null, peso4: null }, { tipo: 'T2', descripcion: 'Tracto camión de dos ejes', img: 'T2.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: null, eje4: null, peso1: 15.4322, peso2: 24.2506, peso3: null, peso4: null }, { tipo: 'T3', descripcion: 'Tracto camión de tres ejes', img: 'T3.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: null, eje4: null, peso1: 15.4322, peso2: 44.092, peso3: null, peso4: null }, { tipo: '2S1', descripcion: 'Tracto camión de 2 ejes y semiremolque de 1 eje', img: '2S1.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: 1, eje4: null, peso1: 15.4322, peso2: 24.2506, peso3: 24.2506, peso4: null }, { tipo: '2S2', descripcion: 'Tracto camión de 2 ejes y semiremolque de 2 ejes', img: '2S2.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: 2, eje4: null, peso1: 15.4322, peso2: 24.2506, peso3: 44.092, peso4: null }, { tipo: '2S3', descripcion: 'Tracto camión de 2 ejes y semiremolque de 3 ejes', img: '2S3.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: 3, eje4: null, peso1: 15.4322, peso2: 24.2506, peso3: 52.9104, peso4: null }, { tipo: '3S1', descripcion: 'Tracto camión de 3 ejes y semiremolque de 1 eje', img: '3S1.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: 1, eje4: null, peso1: 15.4322, peso2: 44.092, peso3: 24.2506, peso4: null }, { tipo: '3S2', descripcion: 'Tracto camión de 3 ejes y semiremolque de 2 ejes', img: '3S2.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: 2, eje4: null, peso1: 15.4322, peso2: 44.092, peso3: 44.092, peso4: null }, { tipo: '3S3', descripcion: 'Tracto camión de 3 ejes y semiremolque de 3 ejes', img: '3S3.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: 3, eje4: null, peso1: 15.4322, peso2: 44.092, peso3: 52.9104, peso4: null }, { tipo: '2R2', descripcion: 'Camión remolcador de 2 ejes y remolque de 2 ejes', img: '2R2.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: 1, eje4: 1, peso1: 15.4322, peso2: 24.2506, peso3: 24.2506, peso4: 24.2506 }, { tipo: '2R3', descripcion: 'Camión remolcador de 2 ejes y remolque de 3 ejes', img: '2R3.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: 1, eje4: 2, peso1: 15.4322, peso2: 24.2506, peso3: 24.2506, peso4: 44.092 }, { tipo: '3R2', descripcion: 'Camión remolcador de 3 ejes y remolque de 2 ejes', img: '3R2.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: 1, eje4: 1, peso1: 15.4322, peso2: 44.092, peso3: 24.2506, peso4: 24.2506 }, { tipo: '3R3', descripcion: 'Camión remolcador de 3 ejes y remolque de 3 ejes', img: '3R3.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: 1, eje4: 2, peso1: 15.4322, peso2: 44.092, peso3: 24.2506, peso4: 44.092 }, { tipo: '2B1', descripcion: 'Camión remolcador de 2 ejes y remolque balanceado de 1 eje', img: '2B1.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: 1, eje4: null, peso1: 15.4322, peso2: 24.2506, peso3: 24.2506, peso4: null }, { tipo: '2B2', descripcion: 'Camión remolcador de 2 ejes y remolque balanceado de 2 ejes', img: '2B2.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: 2, eje4: null, peso1: 15.4322, peso2: 24.2506, peso3: 44.092, peso4: null }, { tipo: '2B3', descripcion: 'Camión remolcador de 2 ejes y remolque balanceado de 3 ejes', img: '2B3.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 1, eje3: 3, eje4: null, peso1: 15.4322, peso2: 24.2506, peso3: 52.9104, peso4: null }, { tipo: '3B1', descripcion: 'Camión remolcador de 3 ejes y remolque balanceado de 1 eje', img: '3B1.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: 1, eje4: null, peso1: 15.4322, peso2: 44.092, peso3: 24.2506, peso4: null }, { tipo: '3B2', descripcion: 'Camión remolcador de 3 ejes y remolque balanceado de 2 ejes', img: '3B2.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: 2, eje4: null, peso1: 15.4322, peso2: 44.092, peso3: 44.092, peso4: null }, { tipo: '3B3', descripcion: 'Camión remolcador de 3 ejes y remolque balanceado de 3 ejes', img: '3B3.PNG', porcentaje: null, checked: false, eje1: 1, eje2: 2, eje3: 3, eje4: null, peso1: 15.4322, peso2: 44.092, peso3: 52.9104, peso4: null }, );


$(function() {
    var clasfvehiculosBody = $('#FlotaVehiculo tbody');

    //Cargar vehiculos en la vista
    $(tipoVehiculos).each(function(i, item) {

        var tr = '<tr index="' + i + '">';
        tr += '<td width="30px"><input class="form-control form-control-sm trafico-checkbox" type="checkbox" value="' + item.tipo + '"/></td>';
        tr += '<td width="40px"><label>' + item.tipo + '</label></td>';
        tr += '<td width="130px"><img src="Images/FlotaVehiculos/' + item.img + '" width="120px" height="35px"/></td>';
        tr += '<td width="160px"><label>' + item.descripcion + '</label></td>';
        tr += '<td width="30px" height="40px"><input class="trafico-porcentaje" type="text" value="' + (item.porcentaje ? item.porcentaje : '') + '"/></td>';
        tr += '</tr>';

        $(clasfvehiculosBody).append(tr);

    });
    $('.trafico-porcentaje').autoNumeric({ aSep: '', aDec: '.', mDec: 2 });




    //Botón cargar vehiculos del modal
    $('#load-Vehiculos').click(function() {

        //1. Validar
        var ptotal = 0;
        var valid = true;
        $('#FlotaVehiculo tbody tr').each(function(i, tr) {
            var chk = $(tr).find('.trafico-checkbox').prop('checked');
            var por = $(tr).find('.trafico-porcentaje').autoNumeric('get') * 1;

            if (chk) {
                if (por > 0) {
                    ptotal += por;
                } else {
                    valid = false;
                }
            }
        });
        if (ptotal > 100) valid = false;
        if (!valid) { 
            alert('Ingrese un porcentaje correcto para todos los items seleccionados.\nPorcentaje total: ' + ptotal);
           
        } 

        //2. Asignar checked y porcentaje
        if (valid) {
            $('#FlotaVehiculo tbody tr').each(function(i, tr) {
                var chk = $(tr).find('.trafico-checkbox').prop('checked');
                var por = $(tr).find('.trafico-porcentaje').autoNumeric('get') * 1;
                var item = tipoVehiculos[i];

                if (chk) {
                    item.checked = true;
                    item.porcentaje = por;
                } else {
                    item.checked = false;
                    item.porcentaje = 0;
                }
            });
            $('#myModal').modal('hide');

        }

        //3. Calcular tráfico
        CalcularTrafico();

        //4. Cargar tabla
        CargarTablaTrafico();
    });

    
    $("#FlotaVehiculo input:text").css("display", "none");
    //Checkbox de seleccion vehiculo
    $(".trafico-checkbox").change(function() {
        var tr = $(this).parents('tr');
        var chk = $(this).prop('checked');
        $(tr).find('.trafico-porcentaje').toggle();
    });


    $(document).on('click', '.item-trafico', function() {
        var index = $(this).attr('index');
        var eje = $(this).attr('eje');
        var item = tipoVehiculos[index];
        var data = item['data' + eje];
        var title = 'Factores de equivalencia: ' + item.tipo + ' - Eje ' + eje;

        $('#Valores_factor_Equivalencia').show();
        $('#Valores_factor_Equivalencia').html('');

        CargarTablaEquivalencia('#Valores_factor_Equivalencia', data, title);        

        
    });




});

function CalcularTrafico() {
    var pt = $('#trafico_ptFlexible').val() * 1;
    var sn = $('#traficoSN_Flexible').val() * 1;

    $(tipoVehiculos).each(function(i, item) {
        CalcularTraficoItem(item, pt, sn);
    });
}

function CalcularTraficoItem(item, pt, sn) {
    if (item.checked) {
        item.data1 = ObtenerInterpolacion(pt, item.eje1, item.peso1, sn);
        item.int1 = item.data1.value;
        item.data2 = ObtenerInterpolacion(pt, item.eje2, item.peso2, sn);
        item.int2 = item.data2.value;
        item.data3 = ObtenerInterpolacion(pt, item.eje3, item.peso3, sn);
        item.int3 = item.data3.value;
        item.data4 = ObtenerInterpolacion(pt, item.eje4, item.peso4, sn);
        item.int4 = item.data4.value;

        console.log('pt: ' + pt + ', eje1: ' + item.eje1 + ', peso1: ' + item.peso1 + ', sn: ' + sn + ', int1: ' + item.int1);
        console.log('pt: ' + pt + ', eje2: ' + item.eje2 + ', peso2: ' + item.peso2 + ', sn: ' + sn + ', int2: ' + item.int2);
        console.log('pt: ' + pt + ', eje3: ' + item.eje3 + ', peso3: ' + item.peso3 + ', sn: ' + sn + ', int3: ' + item.int3);
        console.log('pt: ' + pt + ', eje4: ' + item.eje4 + ', peso4: ' + item.peso4 + ', sn: ' + sn + ', int4: ' + item.int4);

        item.factorCamion = item.int1 + item.int2 + item.int3 + item.int4;
        item.esal = CalcularEsal(item);
    } else {
        item.data1 = null;
        item.int1 = 0;
        item.data2 = null;
        item.int2 = 0;
        item.data3 = null;
        item.int3 = 0;
        item.data4 = null;
        item.int4 = 0;

        item.factorCamion = 0;
        item.esal = 0;
    }
}

function CalcularFactorCrecimiento() {
    var r = $('#traficoTasa_CreFlexible').val() * 1 / 100;
    var d = $('#traficoPeriodo_diseñoFlexible').val() * 1;
    var factorCrecimiento = (Math.pow(1 + r, d) - 1) / Math.log(1 + r);
    return isNaN(factorCrecimiento) ? 0 : factorCrecimiento;
};

function CalcularEsal(item) {
    var tmda = $('#traficoTMDAflexible').val() * 1;
    var porc = item.porcentaje / 100;
    var dire = $('#traficoDireccionalidadFlexible').val() * 1 / 100;
    var fcre = CalcularFactorCrecimiento();
    var fcam = item.factorCamion;
    var esal = tmda * porc * dire * 365 * fcre * fcam;

    return esal;
};

function CargarTablaTrafico() {
    var tbodytrafico = $('#trafico tbody');
    var total = 0;
    $(tbodytrafico).html('');
    

    $(tipoVehiculos).each(function(i, item) {
        if (item.checked) {
            var tr = '<tr>';
            tr += '<td>' + item.tipo + '</td>';
            tr += '<td>' + (item.eje1 ? item.eje1 : '') + '</td>';
            tr += '<td>' + (item.eje2 ? item.eje2 : '') + '</td>';
            tr += '<td>' + (item.eje3 ? item.eje3 : '') + '</td>';
            tr += '<td>' + (item.eje4 ? item.eje4 : '') + '</td>';
            tr += '<td>' + (item.peso1 ? item.peso1 : '') + '</td>';
            tr += '<td>' + (item.peso2 ? item.peso2 : '') + '</td>';
            tr += '<td>' + (item.peso3 ? item.peso3 : '') + '</td>';
            tr += '<td>' + (item.peso4 ? item.peso4 : '') + '</td>';
            tr += '<td>' + item.porcentaje + '</td>';
            tr += '<td><a href="javascript:void(0);" index="' + i + '" class="item-trafico" eje="1" value="'+item.int1.toFixed(4)+'">' + item.int1.toFixed(4) + '</a></td>';
            tr += '<td><a href="javascript:void(0);" index="' + i + '" class="item-trafico" eje="2" value="'+item.int2.toFixed(4)+'">' + item.int2.toFixed(4) + '</a></td>';
            tr += '<td><a href="javascript:void(0);" index="' + i + '" class="item-trafico" eje="3" value="'+item.int3.toFixed(4)+'">' + item.int3.toFixed(4) + '</a></td>';
            tr += '<td><a href="javascript:void(0);" index="' + i + '" class="item-trafico" eje="4" value="'+item.int4.toFixed(4)+'">' + item.int4.toFixed(4) + '</a></td>';
            tr += '<td>' + item.factorCamion.toFixed(3) + '</td>';
            tr += '<td>' + item.esal.toFixed(0) + '</td>';

            $(tbodytrafico).append(tr);



            total += item.esal;


        }

    });

    $('#Esals_Flexible').val(total.toFixed(0));
    
    document.getElementById("suma_esals").innerHTML = total.toFixed(0)
    $('#Valores_factor_Equivalencia').hide();
};
function CargarTablaEquivalencia(div, data, title){
    var tabla = $('<table id="tabla_factor_Equivalencia" width="100%" class="table table-bordered" border="1" cellspacing=0> \
    <thead>\
        <tr>\
            <th class="text-center" colspan="7">' + title + '</th>\
        </tr>\
        <tr>\
            <th>Kips</th>\
            <th>Sn 1</th>\
            <th>Sn 2</th>\
            <th>Sn 3</th>\
            <th>Sn 4</th>\
            <th>Sn 5</th>\
            <th>Sn 6</th>\
        </tr>\
    </thead>\
    <tbody>\
    </tbody>\
</table>');

    $(div).append(tabla);
    var tbody = $(tabla).find('tbody');
    
    if (data.tabla != null) {
        $(data.tabla).each(function(i, dfila) {
            var tr = '<tr class="' + (data.finf == i || data.fsup == i ? 'info' : '') + '">'
            $(dfila).each(function(j, dcol) {
                tr += '<td class="' + (data.csn == j ? 'info' : '') + '">' + dcol + '</td>';
            })
            tr += '</tr>';
            $(tbody).append(tr);
            if (($(tabla).find("tr").hasClass("info")) || ($(tabla).find('td').hasClass("info"))) {
                $(tabla).find('tr.info').css('background-color', "#c0e4fc");
                $(tabla).find('td.info').css('background-color', "#c0e4fc");
                $(tabla).find('tr.info td.info').css('background-color', "#008ED1");
                $(tabla).find('tr.info td.info').css('color', "#FFFFFF");
            }
        });
        $(div).append('<br>'+ data.descript + '<br>');
        $(div).append(data.formulaVar + '<br>');
        $(div).append(data.formula + '<br><br><br>');
        $(div).css("text-align", "center");
    }

    
}